import { NextRequest, NextResponse } from 'next/server';
import { getDatabase } from '@/lib/database';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET || 'genmatch-super-secret-jwt-key-2024';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    console.log('üîê Login attempt for phone:', body.phone);
    
    const { phone, password } = body;

    // Validation
    if (!phone || !password) {
      console.log('‚ùå Missing credentials:', { hasPhone: !!phone, hasPassword: !!password });
      return NextResponse.json(
        { error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' },
        { status: 400 }
      );
    }

    console.log('‚úÖ Validation passed, connecting to database...');
    const db = await getDatabase();
    console.log('‚úÖ Database connected successfully');

    // Get user by phone
    console.log('üîç Searching for user with phone:', phone);
    const user = await db.get(`SELECT id, firstName, lastName, email, phone, userType, 
             studentId, university, address, password
      FROM users WHERE phone = ?`, [phone]);

    if (!user) {
      console.log('‚ùå User not found for phone:', phone);
      return NextResponse.json(
        { error: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' },
        { status: 401 }
      );
    }

    console.log('‚úÖ User found:', { id: user.id, firstName: user.firstName, userType: user.userType });

    // Check password
    console.log('üîê Verifying password...');
    const isValidPassword = await bcrypt.compare(password, user.password);
    if (!isValidPassword) {
      console.log('‚ùå Invalid password for user:', user.id);
      return NextResponse.json(
        { error: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' },
        { status: 401 }
      );
    }

    console.log('‚úÖ Password verified successfully');

    // Generate JWT token
    console.log('üé´ Generating JWT token...');
    const token = jwt.sign(
      { 
        userId: user.id, 
        phone: user.phone,
        userType: user.userType 
      },
      JWT_SECRET,
      { expiresIn: '7d' }
    );

    console.log('‚úÖ JWT token generated successfully');

    // Remove password from user object
    const { password: _, ...userWithoutPassword } = user;

    console.log('‚úÖ Login successful for user:', user.id);

    return NextResponse.json({
      success: true,
      message: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      user: userWithoutPassword,
      token
    });

  } catch (error) {
    console.error('‚ùå Login error:', error);
    
    let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
    
    if (error instanceof Error) {
      if (error.message.includes('database')) {
        errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
      } else if (error.message.includes('jwt')) {
        errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á token';
      }
    }
    
    return NextResponse.json(
      { 
        error: errorMessage,
        details: process.env.NODE_ENV === 'development' ? error instanceof Error ? error.message : 'Unknown error' : undefined
      },
      { status: 500 }
    );
  }
}
